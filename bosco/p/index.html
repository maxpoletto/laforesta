<!DOCTYPE html>
<html>
<head>
    <title>Proprietà Particelle</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../a/f.gif" type="image/gif"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../a/style.css" />
    <link rel="stylesheet" href="style.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.js"></script>
    <script src="../a/map-common.js"></script>
    <script src="compute.js"></script>
    <script src="app.js"></script>
</head>
<body>
    <div id="sat-info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <a href="#" class="modal-close" id="sat-info-close">&times;</a>
            <h4>Dati satellite Sentinel-2</h4>
            <h5>Bande spettrali</h5>
            <p><b>B02</b> (blu, 490 nm) — riflettanza nel visibile, sensibile alla clorofilla e alla correzione atmosferica.</p>
            <p><b>B04</b> (rosso, 665 nm) — fortemente assorbito dalla clorofilla; bassa riflettanza = vegetazione sana.</p>
            <p><b>B08</b> (NIR, 842 nm) — riflesso dalla struttura fogliare; alta riflettanza = chioma densa.</p>
            <p><b>B11</b> (SWIR, 1610 nm) — sensibile al contenuto d'acqua e alla struttura del legno.</p>
            <h5>Indici calcolati</h5>
            <p><b>NDVI</b> = (B08−B04) / (B08+B04) — vigore vegetativo. Valori alti (&gt;0.6) indicano vegetazione densa e sana.</p>
            <p><b>NDMI</b> = (B08−B11) / (B08+B11) — contenuto idrico della chioma. Utile per valutare lo stress idrico e stimare la biomassa.</p>
            <p><b>EVI</b> = 2.5·(B08−B04) / (B08+6·B04−7.5·B02+1) — simile a NDVI ma con correzione atmosferica tramite la banda blu. Non satura nelle foreste dense.</p>
            <p class="modal-footer">Dati: Copernicus Sentinel-2 L2A, risoluzione 10 m. Vedi anche: <a href="https://doi.org/10.1016/j.jag.2025.104560" target="_blank">Yan et al. 2025</a></p>
        </div>
    </div>
    <div id="map"></div>
    <div id="sidebar">
        <h3><a href="../" class="back-link">←</a>Proprietà Particelle</h3>
        <div id="status">Caricamento...</div>
        <div id="coords"></div>

        <div class="section">
            <h4>Mappa</h4>
            <div class="button-row">
                <button onclick="ParcelProps.setBasemap('osm')">OpenStreetMap</button>
                <button onclick="ParcelProps.setBasemap('satellite')">Satellitare</button>
                <button onclick="ParcelProps.setBasemap('topo')">Topografica</button>
            </div>
        </div>

        <div class="section">
            <h4>Visualizza proprietà <a href="#" class="info-toggle" id="info-toggle-prop">(?)</a></h4>
            <select id="property-select" onchange="ParcelProps.setProperty(this.value)">
                <option value="">Nessuna</option>
                <optgroup label="Proprietà particelle">
                    <option value="eta">Età media</option>
                    <option value="governo">Governo</option>
                    <option value="altitudine">Altitudine media</option>
                    <option value="vol_tot">Volume totale (m³)</option>
                    <option value="vol_ha">Volume/ha (m³/ha)</option>
                    <option value="prelievo">Prelievo (m³)</option>
                </optgroup>
                <optgroup label="Satellite">
                    <option value="sat:ndvi">NDVI</option>
                    <option value="sat:ndmi">NDMI</option>
                    <option value="sat:evi">EVI</option>
                    <option value="sat:b08">B08 (NIR)</option>
                    <option value="sat:b04">B04 (Rosso)</option>
                    <option value="sat:b02">B02 (Blu)</option>
                    <option value="sat:b11">B11 (SWIR)</option>
                </optgroup>
            </select>
            <div id="satellite-date-row" class="satellite-date-row">
                <label class="satellite-date-label">Data: </label>
                <select id="satellite-date" onchange="ParcelProps.setSatelliteDate(this.value)">
                </select>
            </div>
            <div id="legend"></div>
        </div>

        <div class="section">
            <h4>Visualizza differenze <a href="#" class="info-toggle" id="info-toggle-diff">(?)</a></h4>
            <select id="diff-select" onchange="ParcelProps.setDiff(this.value)">
                <option value="">Nessuna</option>
                <option value="ndvi">NDVI</option>
                <option value="ndmi">NDMI</option>
                <option value="evi">EVI</option>
            </select>
            <div id="diff-options" class="diff-options hidden">
                <div class="diff-years">
                    <div class="diff-year-col">
                        <label>Anno 1:</label>
                        <select id="diff-year1" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                    <div class="diff-year-col">
                        <label>Anno 2:</label>
                        <select id="diff-year2" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                </div>
                <label class="checkbox-row" id="diff-forest-only-row">
                    <input type="checkbox" id="diff-forest-only" onchange="ParcelProps.updateDiff()">
                    Limita al bosco
                </label>
            </div>
            <div id="diff-legend"></div>
        </div>

        <div class="section">
            <h4>Statistiche</h4>
            <div id="stats"></div>
        </div>
    </div>
</body>
</html>
