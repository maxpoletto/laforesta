<!DOCTYPE html>
<html>
<head>
    <title>Boscoscopio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../a/f.gif" type="image/gif"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="../a/style.css" />
    <link rel="stylesheet" href="style.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.js"></script>
    <script src="https://unpkg.com/chart.js@4.4.7/dist/chart.umd.js"></script>
    <script src="../a/map-common.js"></script>
    <script src="../a/range-slider.js"></script>
    <script src="compute.js"></script>
    <script src="app.js"></script>
</head>
<body>
    <div id="sat-info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <a href="#" class="modal-close" id="sat-info-close">&times;</a>
            <h4>Caratteristiche generali</h4>
                <p>Età media e governo (fustaia, ceduo).</p>
                <p>Altitudine media calcolata come media aritmetica del punto più alto e punto più basso.</p>
            <h4>Dati produzione</h4>
                <p>Stime di volumi e prelievo, dal piano di gestione 2026–2040.</p>
                <p>Produzione annua per particella (in quintali), dal registro mannesi.</p>
            <h4>Dati satellitari</h4>
                <h5>Bande spettrali</h5>
                    <p><b>B02</b> (blu, 490 nm ± 30 nm, 10 m / px): assorbita dalla clorofilla, dispersa dall'atmosfera. Penetra zone ombreggiate. Le aree boschive appaiono più scure.</p>
                    <p><b>B04</b> (rosso, 665 nm ± 15 nm, 10 m / px): riflessa dal fogliamo morto, fortemente assorbita dalla clorofilla. Le aree boschive sane e dense appaiono più scure.</p>
                    <p><b>B08</b> (NIR (infrarosso vicino), 842 nm ± 60 nm, 10 m / px): riflessa dalle foglie. Le chiome dense appaiono più chiare.</p>
                    <p><b>B11</b> (SWIR (infrarosso a onde corte), 1610 nm ± 45 nm, 20 m / px): sensibile al contenuto d'acqua e alla struttura del legno. Le zone umide appaiono più scure di quelle asciutte, e le conifere più scure delle latifoglie.</p>
                <h5>Indici calcolati</h5>
                    <p><b>NDVI</b> = (B08−B04) / (B08+B04): &ldquo;vigore vegetativo&rdquo;. Valori alti (&gt;0.6) indicano vegetazione densa e sana. (Corpi d'acqua: &lt 0, terreno nudo &approx; 0.) [<a href="https://en.wikipedia.org/wiki/Normalized_difference_vegetation_index" target="_blank">Wikipedia</a>]</p>
                    <p><b>NDMI</b> = (B08−B11) / (B08+B11): contenuto idrico della chioma, indipendentemente dalla sua struttura. Utile per valutare stress idrico e stimare biomassa. [<a href="https://doi.org/10.1016/S0034-4257(96)00067-3" target="_blank">Gao, 1996</a>]</p>
                    <p><b>EVI</b> = 2.5·(B08−B04) / (B08+6·B04−7.5·B02+1): simile a NDVI ma con correzione atmosferica tramite la banda blu. Non satura nelle foreste dense. La vegetazione sana cade normalmente nel range 0.20–0.80. [<a href="https://doi.org/10.1016/S0034-4257(02)00096-2" target="_blank">Huete et al., 2002</a>]</p>
            <p class="modal-footer">Dati: <a href="https://dataspace.copernicus.eu/data-collections/copernicus-sentinel-missions/sentinel-2" target="_blank">Copernicus Sentinel-2</a>, <a href="https://custom-scripts.sentinel-hub.com/custom-scripts/sentinel/sentinel-2/" target="_blank">Sentinel Hub</a>. Vedi anche: <a href="https://doi.org/10.1016/j.jag.2025.104560" target="_blank">Yan et al. 2025</a>, <a href="https://clearsky.vision/knowledge/sentinel2-indices-cheatsheet" target="_blank">ClearSky 2025</a>.</p>
        </div>
    </div>
    <div id="ts-modal" class="modal-overlay hidden">
        <div class="modal-content ts-modal-content">
            <a href="#" class="modal-close" id="ts-close">&times;</a>
            <h4 id="ts-title"></h4>
            <canvas id="ts-canvas"></canvas>
        </div>
    </div>
    <div id="map"></div>
    <div id="sidebar">
        <h3><a href="../" class="back-link">←</a>Boscoscopio</h3>
        <div id="status">Caricamento...</div>
        <div id="coords"></div>

        <div class="section">
            <h4>Mappa</h4>
            <div class="button-row">
                <button onclick="ParcelProps.setBasemap('osm')">OpenStreetMap</button>
                <button onclick="ParcelProps.setBasemap('satellite')">Satellitare</button>
                <button onclick="ParcelProps.setBasemap('topo')">Topografica</button>
            </div>
        </div>

        <div class="section">
            <h4>Compresa</h4>
            <select id="compresa-select"></select>
        </div>

        <div class="section">
            <h4>Visualizza caratteristiche <a href="#" class="info-toggle" id="info-toggle-prop">(?)</a></h4>
            <select id="property-select" onchange="ParcelProps.setProperty(this.value)">
                <option value="">Nessuna</option>
                <optgroup label="Caratteristiche generali">
                    <option value="eta">Età media</option>
                    <option value="governo">Governo</option>
                    <option value="altitudine">Altitudine media</option>
                </optgroup>
                <optgroup label="Dati produzione">
                    <option value="vol_tot">Volume totale (m³)</option>
                    <option value="vol_ha">Volume/ha (m³/ha)</option>
                    <option value="prelievo">Prelievo (m³)</option>
                    <option value="prod:storica">Produzione storica (q)</option>
                </optgroup>
                <optgroup label="Dati satellitari">
                    <option value="sat:b02">B02 (Blu)</option>
                    <option value="sat:b04">B04 (Rosso)</option>
                    <option value="sat:b08">B08 (NIR)</option>
                    <option value="sat:b11">B11 (SWIR)</option>
                    <option value="sat:ndvi">NDVI</option>
                    <option value="sat:ndmi">NDMI</option>
                    <option value="sat:evi">EVI</option>
                </optgroup>
            </select>
            <div id="satellite-date-row" class="satellite-date-row">
                <label class="satellite-date-label">Data: </label>
                <select id="satellite-date" onchange="ParcelProps.setSatelliteDate(this.value)">
                </select>
            </div>
            <div id="prod-year-row" class="prod-year-row">
                <label class="prod-year-label">Periodo: </label>
                <span id="prod-year-label" class="prod-year-label"></span>
                <div class="range-slider">
                    <input type="range" id="prod-year-min" min="0" max="1" value="0">
                    <input type="range" id="prod-year-max" min="0" max="1" value="1">
                </div>
            </div>
            <div id="legend"></div>
        </div>
        <div id="ts-section" class="section hidden">
            <h4>Valori storici</h4>
            <div class="button-row">
                <button onclick="ParcelProps.showForestTimeSeries()">Per bosco intero</button>
                <button id="ts-parcel-btn" onclick="ParcelProps.toggleParcelTimeSeries()">Per particella</button>
            </div>
            <div id="ts-hint" class="help-text hidden">Clicca su una particella nella mappa...</div>
        </div>
        <div class="section">
            <h4>Visualizza differenze <a href="#" class="info-toggle" id="info-toggle-diff">(?)</a></h4>
            <select id="diff-select" onchange="ParcelProps.setDiff(this.value)">
                <option value="">Nessuna</option>
                <option value="prod:produzione">Produzione</option>
                <option value="ndvi">NDVI</option>
                <option value="ndmi">NDMI</option>
                <option value="evi">EVI</option>
            </select>
            <div id="diff-options" class="diff-options hidden">
                <div id="sat-diff-dates" class="diff-dates hidden">
                    <div class="diff-date-col">
                        <label>Data 1:</label>
                        <select id="diff-date1" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                    <div class="diff-date-col">
                        <label>Data 2:</label>
                        <select id="diff-date2" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                </div>
                <div id="prod-diff-dates" class="diff-dates hidden">
                    <div class="diff-date-col">
                        <label>Anno 1:</label>
                        <select id="prod-diff-year1" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                    <div class="diff-date-col">
                        <label>Anno 2:</label>
                        <select id="prod-diff-year2" onchange="ParcelProps.updateDiff()"></select>
                    </div>
                </div>
                <label class="checkbox-row hidden" id="diff-forest-only-row">
                    <input type="checkbox" id="diff-forest-only" onchange="ParcelProps.updateDiff()">
                    Limita al bosco
                </label>
            </div>
            <div id="diff-legend"></div>
        </div>

        <div class="section">
            <h4>Statistiche</h4>
            <div id="stats"></div>
        </div>
    </div>
</body>
</html>
